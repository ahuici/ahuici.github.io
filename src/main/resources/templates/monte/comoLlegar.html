<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <title>Summitrack</title>
  <link rel="stylesheet" href="/css/mapa.css">
  <link rel="stylesheet" href="/css/header.css">
  <link rel="icon" type="image/png" th:href="@{/images/IconoSummitrack.png}">

  <!-- Cargar Leaflet primero -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

  <!-- Luego cargar Leaflet Routing Machine -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"/>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>

  <!-- Cargar GraphHopper -->
  <script src="https://unpkg.com/leaflet-routing-machine-graphhopper@latest/dist/leaflet-routing-machine-graphhopper.js"></script>

</head>
<body>

  <div th:insert="fragments/header :: header"></div>

  <a th:href="@{/monte/monte(id=${id}, volver=${volver})}" class="atras">←</a>

  <div id="map"></div>

  <div id="explicacion">
    <p><b>Punto A: </b> Ubicacion actual</p>
    <p><b>Punto B: </b> Destino final</p>
    <p id="aviso"><b>AVISO: </b> La ruta puede tardar unos segundos en cargar</p>
    <p><b>Descargar: </b><button class="btnCrearRuta" id="descargar">Descargar ruta</button>
  </div>

  <script th:inline="javascript">
    /*<![CDATA[*/
    var inicio = {
      latitud: [[${inicio.latitud}]],
      longitud: [[${inicio.longitud}]],
      nombre: [[${inicio.nombre}]]
    };

    var final = {
      latitud: [[${final.latitud}]],
      longitud: [[${final.longitud}]],
      nombre: [[${final.nombre}]]
    };

    var rutaActual = null;

    if (inicio.latitud && inicio.longitud && final.latitud && final.longitud) {
      var map = L.map('map').setView([inicio.latitud, inicio.longitud], 11);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      var iconoMonte = L.icon({
        iconUrl: '/images/pinMonte.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
      });

      var iconoInicio = L.icon({
        iconUrl: '/images/pinInicio.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
      });

      L.marker([final.latitud, final.longitud], { icon: iconoInicio })
        .addTo(map)
        .bindPopup(final.nombre);

      L.marker([inicio.latitud, inicio.longitud], { icon: iconoMonte })
        .addTo(map)
        .bindPopup(inicio.nombre);

      var control = L.Routing.control({
        waypoints: [
          L.latLng(final.latitud, final.longitud),
          L.latLng(inicio.latitud, inicio.longitud)
        ],
        routeWhileDragging: true,
        createMarker: function () { return null; },
        router: L.Routing.osrmv1({
          serviceUrl: 'https://corsproxy.io/?https://router.project-osrm.org/route/v1'
        }),
        lineOptions: {
          styles: [{ color: 'green', weight: 5 }]
        }
      }).addTo(map);

      control.on('routesfound', function (e) {
        rutaActual = e.routes[0];
        console.log("Ruta guardada:", rutaActual);
      });

      map.fitBounds([
        [final.latitud, final.longitud],
        [inicio.latitud, inicio.longitud]
      ]);
    } else {
      console.error("Error: Las ubicaciones 'inicio' o 'final' no están definidas correctamente.");
    }

    // Botón para descargar la ruta
    document.getElementById('descargar').addEventListener('click', function () {
      if (!rutaActual) {
        alert("La ruta debe cargarse primero antes de poder descargarla.");
        return;
      }

      const gpxData = rutaToGPX(rutaActual);
      const blob = new Blob([gpxData], { type: "application/gpx+xml" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "Summitrack.gpx";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    function rutaToGPX(route) {
      const points = route.coordinates;
      const gpxHeader = `<?xml version="1.0" encoding="UTF-8"?>
  <gpx version="1.1" creator="Summitrack" xmlns="http://www.topografix.com/GPX/1/1">
    <trk>
      <name>Ruta creada</name>
      <trkseg>`;
      const gpxFooter = `</trkseg>
    </trk>
  </gpx>`;
      const gpxPoints = points.map(pt =>
        `<trkpt lat="${pt.lat}" lon="${pt.lng}"></trkpt>`
      ).join("\n");

      return `${gpxHeader}\n${gpxPoints}\n${gpxFooter}`;
    }
    /*]]>*/
  </script>
</body>
</html>
